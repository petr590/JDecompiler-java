Добавлена поддержка switch.
Небольшой рефакторинг.
